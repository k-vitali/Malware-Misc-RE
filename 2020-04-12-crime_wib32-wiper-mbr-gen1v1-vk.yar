/////////////////////////////////////////////////////
///////////// MBR WIPER VK //////////////////////////
// COMPILE: Sun Apr 12 10:18:36 2020 UTC ///////////
////////////////////////////////////////////////////

rule crime_wib32_wiper_mbr_gen1v1 {
meta:
description = "Detects MBR wiper version 1 (unpacked)"
author = "@VK_Intel"
reference = "https://twitter.com/VK_Intel/status/1249584183640567808"
description = "Detects MBR wiper version 1"
date = "2020-04-13"
hash = "4cd23a989a8f196b1f49e5e66c6ecfa0cebf63f04950ae4d64127aaedda9e89c"


strings:
$str1 = "VirtualProtect"
$str2 = "IsDebuggerPresent"

$start = {a1 ?? ?? ?? ?? 8b ?? ?? ?? ?? ?? 31 c8 e8 ?? ?? ?? ?? 68 ac 00 00 00 68 10 50 40 00 ff d6 83 c4 08 68 ff 00 00 00 68 ac 00 00 00 68 10 50 40 00 e8 ?? ?? ?? ?? e8 ?? ?? ?? ?? 68 ff 00 00 00 68 ac 00 00 00 68 10 50 40 00 e8 ?? ?? ?? ?? 68 ac 00 00 00 68 10 50 40 00 ff d7 83 c4 08 c7 ?? ?? ?? ?? ?? ?? ?? ?? ?? c7 ?? ?? ?? ?? ?? ?? ?? ?? ?? 68 fe 00 00 00 68 bc 50 40 00 ff d6 83 c4 08 68 ff 00 00 00 68 fe 00 00 00 68 bc 50 40 00 e8 ?? ?? ?? ?? e8 ?? ?? ?? ?? 68 ff 00 00 00 68 fe 00 00 00 68 bc 50 40 00 e8 ?? ?? ?? ?? 68 fe 00 00 00 68 bc 50 40 00 ff d7 83 c4 08 6a 00 ff ?? ?? ?? ?? ??}
$decoder = { 55 89 e5 60 8b ?? ?? 89 f7 8b ?? ?? 8b ?? ?? ac 30 c8 aa 4a 75 ?? 61 c9 c2 0c 00}


condition:
( uint16(0) == 0x5a4d and
( 3 of them )
) or ( all of them )
}

