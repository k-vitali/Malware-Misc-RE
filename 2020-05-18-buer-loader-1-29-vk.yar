////////////////////////////////////////////////////////////
//////////////////// BUER LOADER YARA //////////////////////
////////////////////////////////////////////////////////////

rule crime_win32_ldr_buer_1_29 {
meta:
  description = "Detects Buer loader 1.29 (unpacked)"
  author = "@VK_Intel"
  reference = "https://twitter.com/VK_Intel/status/1262391041581342722"
  tlp = "white"
  date = "2020-05-19"

strings:
	$str1 = "shellcode"
	$str2 = "uacbypass"
	$str3 = "localscript"

	$decoder_code = { 89 ?? ?? 0f ?? ?? ?? ?? ?? 53 56 33 f6 57 8b c6 88 ?? ?? ?? ?? ?? ?? 40 3d 00 01 00 00 72 ?? 8b fe 33 d2 8a ?? ?? ?? ?? ?? ?? 8b c7 f7 ?? ?? 0f ?? ?? ?? 03 c6 0f b6 cb 03 c8 0f b6 f1 8b ?? ?? 8a ?? ?? ?? ?? ?? ?? 88 ?? ?? ?? ?? ?? ?? 47 88 ?? ?? ?? ?? ?? ?? 81 ff 00 01 00 00 72 ?? 8b ?? ?? 33 f6 8b ?? ?? 8b fe 89 ?? ?? 8d ?? ?? 0f b6 f8 8a ?? ?? ?? ?? ?? ?? 0f b6 c1 03 c6 0f b6 f0 8a ?? ?? ?? ?? ?? ?? 88 ?? ?? ?? ?? ?? ?? 8b ?? ??}
	$cmd_prologue_code = {83 ?? ?? ?? ?? ?? ?? 53 56 57 89 ?? ?? 8b f9 75 ?? e8 ?? ?? ?? ?? 8b cf e8 ?? ?? ?? ?? 8b f0 6a 04 68 00 30 00 00 8d ?? ?? ?? ?? ?? ?? 51 6a 00 ff ?? ?? ?? ?? ?? 8b d8 8b cf 8b d3 89 ?? ?? e8 ?? ?? ?? ?? 3d be ba ad ab 0f ?? ?? ?? ?? ?? 83 fe 05 0f ?? ?? ?? ?? ?? 6a 04 68 00 30 00 00 33 ff 68 11 04 00 00 57 89 ?? ?? ff ?? ?? ?? ?? ?? 6a 04 68 00 30 00 00 8d ?? ?? 8b d8 51 57 89 ?? ?? ff ?? ?? ?? ?? ?? 8b ?? ?? 8b f8 89 ?? ?? e8 ?? ?? ?? ??}
	$ru_check_code =  {8d ?? ?? 33 f6 50 56 89 ?? ?? ff ?? ?? ?? ?? ?? 85 c0 78 ?? 8b ?? ?? b9 19 04 00 00 66 3b c1 74 ?? 83 c1 09 66 3b c1 74 ?? b9 23 04 00 00 66 3b c1 74 ?? 83 c1 08 66 3b c1 74 ?? b9 3f 04 00 00 66 3b c1 74 ?? b9 18 08 00 00 66 3b c1 74 ?? 41 66 3b c1 75 ??}

condition:
( uint16(0) == 0x5a4d and
( 3 of them )
) or ( all of them )
}
