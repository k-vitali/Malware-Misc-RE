
/*
PAYLOAD URL:

http://smart.cloudnetwork.kz/
http://static.apiinformation.kz/
http://secure.jscontentmaker.kz/
http://secure.jsc0nten1maker.com/
http://static.apiinformationsec.com/
http://mel.cloudcontentsmak.com/
http://nicru.supermicrotransapi.ru/
http://tel.jsapisettings.kz/
http://js.securetopdevelopment.kz/
http://noone.contentmakersbyakamai.ru/
*/

rule crime_win32_loader_delphiload_1 {
meta:
description = "Detects Delphi Loader (shiotob)"
author = "@VK_Intel"
reference = "twitter"
tlp = "white"
date = "2020-05-06"


strings:
	$str1 = "[bid]" wide
	$str2 = "scrobj.dll" wide
	$str3 = "ShowMagic"

	$magic_func = {50 e8 ?? ?? ?? ?? 89 ?? ?? 83 ?? ?? ?? 75 ?? b8 f8 91 43 00 e8 ?? ?? ?? ?? a1 ?? ?? ?? ?? 33 d2 89 ?? e8 ?? ?? ?? ?? e8 ?? ?? ?? ?? e9 ?? ?? ?? ?? 68 2c 92 43 00 8b ?? ?? 50 e8 ?? ?? ?? ?? 8b d8 85 db 75 ?? b8 44 92 43 00 e8 ?? ?? ?? ?? a1 ?? ?? ?? ?? 33 d2 89 ?? e8 ?? ?? ?? ?? e8 ?? ?? ?? ?? e9 ?? ?? ?? ?? b8 84 92 43 00 e8 ?? ?? ?? ?? a1 ?? ?? ?? ?? 8b ?? 50 a1 ?? ?? ?? ?? 8b ?? 50 a1 ?? ?? ?? ?? 8b ??}
	$smpt_check = {55 68 72 8a 43 00 64 ?? ?? 64 ?? ?? b8 90 8a 43 00 e8 ?? ?? ?? ?? 6a 03 8d ?? ?? b9 01 00 00 00 8b ?? ?? ?? ?? ?? e8 ?? ?? ?? ?? 83 c4 04 8d ?? ?? 8b ?? ?? ?? ?? ?? e8 ?? ?? ?? ?? 6a 03 8d ?? ?? b9 01 00 00 00 8b ?? ?? ?? ?? ?? e8 ?? ?? ?? ?? 83 c4 04 8b ?? ?? ba b4 8a 43 00 e8 ?? ?? ?? ?? 8b ?? ?? 83 c0 04 ba e8 8a 43 00 e8 ?? ?? ?? ?? 8b ?? ?? 83 c0 08 ba 1c 8b 43 00 e8 ?? ?? ?? ?? 8b ?? ?? 8d ?? ?? 8b ?? ?? ?? ?? ?? e8 ?? ?? ?? ?? 33 c0 89 ?? ?? b2 01 a1 ?? ?? ?? ?? e8 ?? ?? ?? ?? 89 ?? ?? ba 10 27 00 00 8b ?? ??}
	$hook_instll = {6a 00 49 75 ?? 53 56 57 89 ?? ?? 33 c0 55 68 43 a8 43 00 64 ?? ?? 64 ?? ?? 33 c0 55 68 f0 a6 43 00 64 ?? ?? 64 ?? ?? b8 60 a8 43 00 e8 ?? ?? ?? ?? b8 24 97 43 00 e8 ?? ?? ?? ?? 84 c0 75 ?? b8 88 a8 43 00 e8 ?? ?? ?? ?? e8 ?? ?? ?? ?? e9 ?? ?? ?? ?? b2 01 a1 ?? ?? ?? ?? e8 ?? ?? ?? ?? a3 ?? ?? ?? ?? b2 01 a1 ?? ?? ?? ?? e8 ?? ?? ?? ?? a3 ?? ?? ?? ?? e9 ?? ?? ?? ??}

condition:
( uint16(0) == 0x5a4d and
( 3 of them )
) or ( all of them )
}
