//////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////// Qbot MiniUPNP "qsort" /////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////

rule crime_win64_upnp_qbot_1 {
meta:
description = "Detects Qbot "qsort" Lib MiniUPNP"
author = "@VK_Intel"
reference = "twitter"
tlp = "white"
date = "2020-04-07"


strings:
$str1 = "qsort"
$str2 = "libminiupnpc"

$start = { ff ?? ?? ?? ?? ?? e8 ?? ?? ?? ?? 83 c4 18 89 ?? ?? 3b c6 74 ?? 6a 01 56 ff ?? ?? 50 e8 ?? ?? ?? ?? 8d ?? ?? 56 50 e8 ?? ?? ?? ?? 83 c4 18 68 e4 8d c3 00 56 e8 ?? ?? ?? ?? 6a 04 e8 ?? ?? ?? ?? 83 c4 0c 3b c6 74 ?? 50 e8 ?? ?? ?? ?? 59 85 c0 0f ?? ?? ?? ?? ?? e8 ?? ?? ?? ?? 6a ff ff ?? ?? ?? ?? ?? 50 ff ?? ?? ?? ?? ?? 8d ?? ?? ?? ?? ?? 50 68 02 02 00 00 ff ?? ?? ?? ?? ?? e8 ?? ?? ?? ?? e8 ?? ?? ?? ?? e8 ?? ?? ?? ?? 56 56 56 68 d4 73 c1 00 e8 ?? ?? ?? ?? 83 c4 10 e8 ?? ?? ?? ?? e8 ?? ?? ?? ?? e8 ?? ?? ?? ?? 89 ?? ?? ?? ?? ?? 89 ?? ?? ?? ?? ?? eb ?? 68 60 79 c3 00 e8 ?? ?? ?? ?? ff ?? ?? ?? ?? ?? ff ?? ?? ?? ?? ?? e8 ?? ?? ?? ?? 83 c4 0c 39 ?? ?? ?? ?? ?? 75 ?? 68 88 13 00 00 ff ?? ?? ?? ?? ?? ff ?? ?? ?? ?? ?? 8b f8 3b fe 74 ??}
$event_seq = {33 db 3b c3 74 ?? 38 ?? 74 ?? 50 6a 06 e8 ?? ?? ?? ?? 68 e4 8d c3 00 53 e8 ?? ?? ?? ?? 83 c4 10 eb ?? 6a 06 e8 ?? ?? ?? ?? 59 85 c0 75 ?? 68 50 16 00 00 e8 ?? ?? ?? ?? 59 e8 ?? ?? ?? ?? a1 ?? ?? ?? ?? 3b c3 75 ?? 39 ?? ?? ?? ?? ?? 75 ?? 53 53 53 53 ff ?? ?? ?? ?? ?? a3 ?? ?? ?? ?? 3b c3 75 ?? 6a fe 58 eb ?? 68 82 26 00 00 e8 ?? ?? ?? ?? 59 a3 ?? ?? ?? ?? 3b c3 75 ?? 6a fd eb ?? 83 ?? ?? ?? 6a 01 53 53 68 5a 23 c1 00 e8 ?? ?? ?? ?? 83 c4 10 a3 ?? ?? ?? ?? 3b c3 74 ?? 33 c0 5b 5d c3 ff ?? e8 ?? ?? ?? ?? 59 85 c0 75 ?? a1 ?? ?? ?? ?? ff ?? ?? e8 ?? ?? ?? ?? c7 ?? ?? ?? ?? ?? ?? 53 ff ?? ?? ?? ?? ?? e8 ?? ?? ?? ?? a1 ?? ?? ?? ?? 83 ?? ?? ?? 6a 01 53 53 68 5a 23 c1 00 e8 ?? ?? ?? ?? 83 c4 1c a3 ?? ?? ?? ?? 3b c3 75 ?? 6a fc e9 ?? ?? ?? ?? ff ?? ?? ?? ?? ?? ff ?? ?? ?? ?? ?? 85 c0 75 ?? 6a fb e9 ?? ?? ?? ??}


condition:
( uint16(0) == 0x5a4d and
( 3 of them )
) or ( all of them )
}

